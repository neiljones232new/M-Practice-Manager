generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Practice {
  id                          String            @id @default(cuid())
  name                        String
  legalEntityName             String?
  tradingName                 String?
  description                 String?
  website                     String?
  mainEmail                   String            @db.VarChar(320)
  mainPhone                   String?
  fax                         String?
  addressId                   String?           @unique
  practicingCertificateNumber String?
  professionalBody            String?
  membershipNumber            String?
  vatNumber                   String?
  taxReference                String?
  bankAccountName             String?
  bankAccountNumber           String?
  bankSortCode                String?
  bankIban                    String?
  bankSwift                   String?
  piInsurer                   String?
  piPolicyNumber              String?
  piExpiryDate                DateTime?
  piCoverAmount               Decimal?          @db.Decimal(12, 2)
  piExcess                    Decimal?          @db.Decimal(8, 2)
  moneyLaunderingSupervisor   String?
  amlSupervisorNumber         String?
  amlRegistrationDate         DateTime?
  lastAmlCheckDate            DateTime?
  nextAmlCheckDueDate         DateTime?
  companiesHouseApiKey        String?
  companiesHouseWebhook       String?
  chLastSyncDate              DateTime?
  hmrcClientId                String?
  hmrcClientSecret            String?
  hmrcEnvironment             String?
  mtdVatEnabled               Boolean           @default(false)
  mtdPayeEnabled              Boolean           @default(false)
  mtdItsaEnabled              Boolean           @default(false)
  defaultHourlyRate           Decimal?          @db.Decimal(10, 2)
  currency                    String            @default("GBP")
  timezone                    String            @default("Europe/London")
  dateFormat                  String            @default("DD/MM/YYYY")
  numberFormat                String?
  workingDays                 String[]
  workingHoursStart           String            @default("09:00")
  workingHoursEnd             String            @default("17:30")
  lunchBreakStart             String?
  lunchBreakEnd               String?
  logoPath                    String?
  primaryColor                String?           @default("#2563eb")
  secondaryColor              String?           @default("#64748b")
  emailHeaderTemplate         String?
  emailFooterTemplate         String?
  emailNotificationsEnabled   Boolean           @default(true)
  smsNotificationsEnabled     Boolean           @default(false)
  slackWebhookUrl             String?
  teamsWebhookUrl             String?
  backupEnabled               Boolean           @default(true)
  backupFrequency             String            @default("daily")
  backupRetentionDays         Int               @default(90)
  twoFactorAuthEnabled        Boolean           @default(false)
  dataRetentionMonths         Int               @default(84)
  autoArchiveClients          Boolean           @default(false)
  enforceStrongPasswords      Boolean           @default(true)
  createdAt                   DateTime          @default(now())
  updatedAt                   DateTime          @updatedAt
  lastUpdatedBy               String?
  branches                    PracticeBranch[]
  settings                    PracticeSetting[]
  address                     Address?          @relation("PracticeAddress", fields: [addressId], references: [id])

  @@map("practices")
}

model PracticeBranch {
  id           String   @id @default(cuid())
  practiceId   String
  name         String
  isMain       Boolean  @default(false)
  addressId    String?
  phone        String?
  email        String?  @db.VarChar(320)
  manager      String?
  openingHours Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  address      Address? @relation("BranchAddress", fields: [addressId], references: [id])
  practice     Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@index([practiceId])
  @@map("practice_branches")
}

model PracticeSetting {
  id          String   @id @default(cuid())
  practiceId  String
  category    String
  key         String
  value       Json
  description String?
  isEditable  Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  practice    Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  @@unique([practiceId, category, key])
  @@index([practiceId, category])
  @@map("practice_settings")
}

model Portfolio {
  code        Int         @id
  name        String
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  clients     Client[]
  refBuckets  RefBucket[]

  @@map("portfolios")
}

model RefBucket {
  id            String    @id @default(cuid())
  portfolioCode Int
  alpha         String
  nextIndex     Int       @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  portfolio     Portfolio @relation(fields: [portfolioCode], references: [code])

  @@unique([portfolioCode, alpha])
  @@map("ref_buckets")
}

model User {
  id                 String        @id @default(cuid())
  email              String        @unique
  name               String?
  role               UserRole      @default(STAFF)
  isActive           Boolean       @default(true)
  lastLoginAt        DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  createdAccounts    AccountsSet[] @relation("AccountsCreator")
  lastEditedAccounts AccountsSet[] @relation("AccountsEditor")
  createdDocuments   Document[]
  assignedTasks      Task[]        @relation("TaskAssignee")
  createdTasks       Task[]        @relation("TaskCreator")
  createdTemplates   Template[]

  @@map("users")
}

model Client {
  id                               String              @id
  name                             String
  type                             ClientType
  status                           ClientStatus        @default(ACTIVE)
  mainEmail                        String?
  mainPhone                        String?
  registeredNumber                 String?             @unique
  utrNumber                        String?             @unique
  vatNumber                        String?             @unique
  payeReference                    String?             @unique
  accountsOfficeReference          String?
  cisUtr                           String?             @unique
  eoriNumber                       String?             @unique
  mtdVatEnabled                    Boolean             @default(false)
  mtdItsaEnabled                   Boolean             @default(false)
  hmrcCtStatus                     String?
  hmrcSaStatus                     String?
  hmrcVatStatus                    String?
  hmrcPayeStatus                   String?
  hmrcCisStatus                    String?
  hmrcMtdVatStatus                 String?
  hmrcMtdItsaStatus                String?
  hmrcEoriStatus                   String?
  incorporationDate                DateTime?
  yearEnd                          DateTime?
  accountsNextDue                  DateTime?
  accountsLastMadeUpTo             DateTime?
  confirmationNextDue              DateTime?
  confirmationLastMadeUpTo         DateTime?
  accountsAccountingReferenceDay   Int?
  accountsAccountingReferenceMonth Int?
  portfolioCode                    Int
  annualFees                       Decimal?
  tasksDueCount                    Int                 @default(0)
  createdAt                        DateTime            @default(now())
  updatedAt                        DateTime            @updatedAt
  addressId                        String?
  lastSyncedAt                     DateTime?
  source                           String?
  accountsSets                     AccountsSet[]
  calendarEvents                   CalendarEvent[]
  parties                          ClientParty[]
  clientProfile                    ClientProfile?
  address                          Address?            @relation(fields: [addressId], references: [id])
  portfolio                        Portfolio           @relation(fields: [portfolioCode], references: [code])
  companiesHouseData               CompaniesHouseData?
  complianceItems                  ComplianceItem[]
  documents                        Document[]
  auditEvents                      Event[]             @relation("ClientEvents")
  filings                          Filing[]
  generatedReports                 GeneratedReport[]
  services                         Service[]
  tasks                            Task[]
  taxCalculations                  TaxCalculation[]

  @@index([portfolioCode])
  @@index([name])
  @@index([registeredNumber])
  @@map("clients")
}

model ClientProfile {
  id                            String          @id @default(cuid())
  clientId                      String          @unique
  mainContactName               String?
  partnerResponsible            String?
  clientManager                 String?
  lifecycleStatus               LifecycleStatus @default(PROSPECT)
  engagementType                String?
  engagementLetterSigned        Boolean         @default(false)
  onboardingDate                DateTime?
  disengagementDate             DateTime?
  onboardingStartedAt           DateTime?
  wentLiveAt                    DateTime?
  ceasedAt                      DateTime?
  dormantSince                  DateTime?
  accountingPeriodEnd           DateTime?
  nextAccountsDueDate           DateTime?
  nextCorporationTaxDueDate     DateTime?
  statutoryYearEnd              DateTime?
  vatRegistrationDate           DateTime?
  vatPeriodStart                DateTime?
  vatPeriodEnd                  DateTime?
  vatStagger                    VatStagger      @default(NONE)
  payrollPayDay                 Int?
  payrollPeriodEndDay           Int?
  corporationTaxUtr             String?
  vatNumber                     String?
  vatScheme                     String?
  vatReturnFrequency            String?
  vatQuarter                    String?
  payeReference                 String?
  payeAccountsOfficeReference   String?
  cisRegistered                 Boolean         @default(false)
  cisUtr                        String?
  personalUtr                   String?
  payrollRtiRequired            Boolean         @default(false)
  amlCompleted                  Boolean         @default(false)
  clientRiskRating              String?
  annualFee                     Decimal?
  monthlyFee                    Decimal?
  selfAssessmentRequired        Boolean         @default(false)
  selfAssessmentFiled           Boolean         @default(false)
  tradingName                   String?
  companyType                   String?
  registeredAddress             String?
  authenticationCode            String?
  employeeCount                 Int?
  payrollFrequency              String?
  contactPosition               String?
  telephone                     String?
  mobile                        String?
  email                         String?
  preferredContactMethod        String?
  correspondenceAddress         String?
  feeArrangement                String?
  businessBankName              String?
  accountLastFour               String?
  directDebitInPlace            Boolean         @default(false)
  paymentIssues                 String?
  nationalInsuranceNumber       String?
  dateOfBirth                   DateTime?
  personalAddress               String?
  personalTaxYear               String?
  selfAssessmentTaxYear         String?
  linkedCompanyNumber           String?
  directorRole                  String?
  companyStatusDetail           String?
  jurisdiction                  String?
  sicCodes                      String?
  sicDescriptions               String?
  registeredOfficeFull          String?
  directorCount                 Int?
  pscCount                      Int?
  currentDirectors              String?
  currentPscs                   String?
  lastChRefresh                 DateTime?
  accountsOverdue               Boolean         @default(false)
  confirmationStatementOverdue  Boolean         @default(false)
  nextAccountsMadeUpTo          DateTime?
  nextAccountsDueBy             DateTime?
  lastAccountsMadeUpTo          DateTime?
  nextConfirmationStatementDate DateTime?
  confirmationStatementDueBy    DateTime?
  lastConfirmationStatementDate DateTime?
  notes                         String?
  specialCircumstances          String?
  seasonalBusiness              Boolean         @default(false)
  dormant                       Boolean         @default(false)
  doNotContact                  Boolean         @default(false)
  createdAt                     DateTime        @default(now())
  updatedAt                     DateTime        @updatedAt
  client                        Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("client_profiles")
}

model Address {
  id       String           @id @default(cuid())
  line1    String
  line2    String?
  city     String?
  county   String?
  postcode String
  country  String
  clients  Client[]
  branches PracticeBranch[] @relation("BranchAddress")
  practice Practice?        @relation("PracticeAddress")

  @@map("addresses")
}

model Service {
  id              String           @id @default(cuid())
  clientId        String
  kind            String
  frequency       String?
  fee             Decimal?
  annualized      Decimal?
  status          String           @default("ACTIVE")
  nextDue         DateTime?
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  complianceItems ComplianceItem[]
  client          Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks           Task[]

  @@map("services")
}

model ComplianceItem {
  id          String           @id @default(cuid())
  clientId    String
  serviceId   String?
  type        String
  description String
  dueDate     DateTime?
  status      ComplianceStatus @default(PENDING)
  source      ComplianceSource
  reference   String?
  period      String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  client      Client           @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service     Service?         @relation(fields: [serviceId], references: [id])

  @@map("compliance_items")
}

model Task {
  id          String     @id @default(cuid())
  title       String
  clientId    String?
  serviceId   String?
  description String?
  dueDate     DateTime?
  assigneeId  String?
  creatorId   String?
  status      TaskStatus @default(TODO)
  priority    Priority   @default(MEDIUM)
  tags        String[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  assignee    User?      @relation("TaskAssignee", fields: [assigneeId], references: [id])
  client      Client?    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  creator     User?      @relation("TaskCreator", fields: [creatorId], references: [id])
  service     Service?   @relation(fields: [serviceId], references: [id])

  @@map("tasks")
}

model Document {
  id           String           @id @default(cuid())
  clientId     String?
  filename     String
  originalName String
  mimeType     String
  size         Int
  category     DocumentCategory
  isArchived   Boolean          @default(false)
  uploadedById String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  client       Client?          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  uploadedBy   User?            @relation(fields: [uploadedById], references: [id])

  @@map("documents")
}

model Template {
  id           String           @id @default(cuid())
  name         String
  description  String
  category     TemplateCategory
  type         TemplateType
  content      String
  placeholders Json?
  metadata     Json?
  createdById  String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  createdBy    User?            @relation(fields: [createdById], references: [id])

  @@map("templates")
}

model Person {
  id            String        @id @default(cuid())
  fullName      String?
  email         String?       @unique
  phone         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  clientParties ClientParty[]

  @@map("people")
}

model ClientParty {
  id               String    @id @default(cuid())
  clientId         String
  personId         String?
  primaryContact   Boolean   @default(false)
  suffixLetter     String?
  ownershipPercent Float?
  appointedAt      DateTime?
  resignedAt       DateTime?
  role             String?
  partyRef         String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  client           Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  person           Person?   @relation(fields: [personId], references: [id])

  @@map("client_parties")
}

model AccountsSet {
  id                 String              @id @default(cuid())
  clientId           String
  companyNumber      String
  framework          AccountingFramework
  status             AccountsSetStatus   @default(DRAFT)
  periodStartDate    DateTime
  periodEndDate      DateTime
  isFirstYear        Boolean             @default(false)
  companyData        Json?
  frameworkData      Json?
  policiesData       Json?
  profitLossData     Json?
  balanceSheetData   Json?
  notesData          Json?
  approvalData       Json?
  validationErrors   Json?
  validationWarnings Json?
  isBalanced         Boolean             @default(true)
  htmlUrl            String?
  pdfUrl             String?
  createdById        String?
  lastEditedById     String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  client             Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  createdBy          User?               @relation("AccountsCreator", fields: [createdById], references: [id])
  lastEditedBy       User?               @relation("AccountsEditor", fields: [lastEditedById], references: [id])

  @@map("accounts_sets")
}

model CompaniesHouseData {
  id             String   @id @default(cuid())
  clientId       String   @unique
  companyNumber  String   @unique
  companyDetails Json?
  officers       Json?
  filingHistory  Json?
  charges        Json?
  pscs           Json?
  lastFetched    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([companyNumber])
  @@index([clientId])
  @@index([lastFetched])
  @@map("companies_house_data")
}

model Filing {
  id            String    @id @default(cuid())
  clientId      String
  type          String
  period        String?
  dueDate       DateTime?
  status        String
  source        String
  transactionId String?
  category      String?
  description   String?
  actionDate    DateTime?
  filedDate     DateTime?
  barcode       String?
  pages         Int?
  paperFiled    Boolean?
  reference     String?
  madeUpTo      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([dueDate])
  @@index([status])
  @@index([type])
  @@index([transactionId])
  @@map("filings")
}

model TaxCalculation {
  id                String             @id @default(cuid())
  clientId          String?
  companyId         String?
  calculationType   TaxCalculationType
  taxYear           String
  parameters        Json?
  optimizedSalary   Decimal?           @db.Decimal(12, 2)
  optimizedDividend Decimal?           @db.Decimal(12, 2)
  totalTakeHome     Decimal?           @db.Decimal(12, 2)
  totalTaxLiability Decimal?           @db.Decimal(12, 2)
  estimatedSavings  Decimal?           @db.Decimal(12, 2)
  recommendations   Json?
  calculatedAt      DateTime?          @default(now())
  calculatedBy      String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  reports           GeneratedReport[]
  client            Client?            @relation(fields: [clientId], references: [id])
  scenarios         TaxScenario[]

  @@index([clientId])
  @@index([calculatedAt])
  @@index([calculationType])
  @@index([taxYear])
  @@map("tax_calculations")
}

model TaxScenario {
  id             String         @id @default(cuid())
  calculationId  String
  scenarioName   String?
  salary         Decimal?       @db.Decimal(12, 2)
  dividend       Decimal?       @db.Decimal(12, 2)
  incomeTax      Decimal?       @db.Decimal(12, 2)
  employeeNi     Decimal?       @db.Decimal(12, 2)
  employerNi     Decimal?       @db.Decimal(12, 2)
  dividendTax    Decimal?       @db.Decimal(12, 2)
  corporationTax Decimal?       @db.Decimal(12, 2)
  totalTax       Decimal?       @db.Decimal(12, 2)
  takeHome       Decimal?       @db.Decimal(12, 2)
  effectiveRate  Decimal?       @db.Decimal(8, 4)
  calculation    TaxCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  @@index([calculationId])
  @@map("tax_scenarios")
}

model GeneratedReport {
  id            String          @id @default(cuid())
  clientId      String?
  calculationId String?
  templateId    String?
  title         String
  content       Json?
  format        ReportFormat
  filePath      String?
  generatedAt   DateTime?       @default(now())
  generatedBy   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  calculation   TaxCalculation? @relation(fields: [calculationId], references: [id])
  client        Client?         @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([generatedAt])
  @@map("generated_reports")
}

model CalendarEvent {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  clientId    String?
  taskId      String?
  type        String    @default("APPOINTMENT")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  client      Client?   @relation(fields: [clientId], references: [id])

  @@index([startDate])
  @@index([clientId])
  @@map("calendar_events")
}

model Event {
  id        String   @id @default(cuid())
  ts        DateTime @default(now())
  actor     String
  entity    String
  entityId  String
  entityRef String?
  action    String
  payload   Json
  client    Client   @relation("ClientEvents", fields: [entityId], references: [id])

  @@index([entity, entityId])
  @@index([entityRef])
  @@index([ts])
  @@map("events")
}

enum UserRole {
  ADMIN
  PARTNER
  MANAGER
  STAFF
  READONLY
}

enum ClientType {
  COMPANY
  INDIVIDUAL
  SOLE_TRADER
  PARTNERSHIP
  LLP
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum LifecycleStatus {
  PROSPECT
  ONBOARDING
  ACTIVE
  DORMANT
  CEASED
}

enum VatStagger {
  A
  B
  C
  NONE
}

enum ComplianceStatus {
  PENDING
  FILED
  OVERDUE
  EXEMPT
}

enum ComplianceSource {
  COMPANIES_HOUSE
  HMRC
  MANUAL
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  REVIEW
  COMPLETED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum DocumentCategory {
  TAX
  ACCOUNTS
  COMPLIANCE
  REPORTS
  INVOICES
  RECEIPTS
  BANK_STATEMENTS
  OTHER
}

enum TemplateCategory {
  TAX
  HMRC
  VAT
  COMPLIANCE
  GENERAL
  ENGAGEMENT
  CLIENT
  REPORTS
  COMMERCIAL
}

enum TemplateType {
  DOCUMENT
  TASK
  SERVICE
  EMAIL
}

enum AccountingFramework {
  MICRO_FRS105
  SMALL_FRS102_1A
  DORMANT
  SOLE_TRADER
  INDIVIDUAL
}

enum AccountsSetStatus {
  DRAFT
  IN_REVIEW
  READY
  LOCKED
}

enum TaxCalculationType {
  SALARY_OPTIMIZATION
  SCENARIO_COMPARISON
  CORPORATION_TAX
  DIVIDEND_TAX
  INCOME_TAX
  SOLE_TRADER
}

enum ReportFormat {
  PDF
  HTML
}
