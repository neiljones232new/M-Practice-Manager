// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Portfolio {
  code        Int      @id
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clients Client[]

  @@map("portfolios")
}

enum ClientType {
  COMPANY
  INDIVIDUAL
  SOLE_TRADER
  PARTNERSHIP
  LLP
}

model Client {
  id              String     @id @default(cuid())
  ref             String     @unique
  name            String
  type            ClientType
  portfolioCode   Int
  status          String     @default("ACTIVE")
  mainEmail       String?    @db.VarChar(320)
  mainPhone       String?
  
  // Practice profile fields (Standard B parity with client.json)
  utrNumber                     String?
  mainContactName               String?
  partnerResponsible            String?
  clientManager                 String?
  lifecycleStatus               String?
  engagementType                String?
  engagementLetterSigned        Boolean?
  onboardingDate                String?
  disengagementDate             String?
  onboardingStartedAt           String?
  wentLiveAt                    String?
  ceasedAt                      String?
  dormantSince                  String?
  accountingPeriodEnd           String?
  nextAccountsDueDate           String?
  nextCorporationTaxDueDate     String?
  statutoryYearEnd              String?
  vatRegistrationDate           String?
  vatPeriodStart                String?
  vatPeriodEnd                  String?
  vatStagger                    String?
  payrollPayDay                 Int?
  payrollPeriodEndDay           Int?
  corporationTaxUtr             String?
  vatNumber                     String?
  vatScheme                     String?
  vatReturnFrequency            String?
  vatQuarter                    String?
  payeReference                 String?
  payeAccountsOfficeReference   String?
  accountsOfficeReference       String?
  cisRegistered                 Boolean?
  cisUtr                        String?
  payrollRtiRequired            Boolean?
  amlCompleted                  Boolean?
  clientRiskRating              String?
  annualFee                     Decimal?  @db.Decimal(12, 2)
  monthlyFee                    Decimal?  @db.Decimal(12, 2)
  personalUtr                   String?
  selfAssessmentRequired        Boolean?
  selfAssessmentFiled           Boolean?
  tradingName                   String?
  registeredAddress             String?
  authenticationCode            String?
  employeeCount                 Int?
  payrollFrequency              String?
  contactPosition               String?
  telephone                     String?
  mobile                        String?
  email                         String?   @db.VarChar(320)
  preferredContactMethod        String?
  correspondenceAddress         String?
  feeArrangement                String?
  businessBankName              String?
  accountLastFour               String?
  directDebitInPlace            Boolean?
  paymentIssues                 String?
  notes                         String?
  specialCircumstances          String?
  seasonalBusiness              Boolean?
  dormant                       Boolean?
  doNotContact                  Boolean?
  nationalInsuranceNumber       String?
  dateOfBirth                   String?
  personalAddress               String?
  personalTaxYear               String?
  selfAssessmentTaxYear         String?
  linkedCompanyNumber           String?
  directorRole                  String?
  clientType                    String?
  
  // Companies House specific fields
  companyNumber   String?    @unique // company_number from CH API
  companyName     String?    // company_name from CH API  
  companyStatus   String?    // company_status from CH API
  companyType     String?    // type from CH API (ltd, plc, etc.)
  dateOfCreation  DateTime?  // date_of_creation from CH API
  dateOfCessation DateTime?  // date_of_cessation from CH API
  jurisdiction    String?    // jurisdiction from CH API
  sicCodes        String[]   // sic_codes from CH API
  etag            String?    // etag from CH API for change detection
  
  // Registered office address (from CH API)
  registeredOfficeAddressLine1  String?
  registeredOfficeAddressLine2  String?
  registeredOfficeLocality      String?
  registeredOfficeRegion        String?
  registeredOfficePostalCode    String?
  registeredOfficeCountry       String?
  
  // Accounts information (from CH API)
  accountsNextDue               DateTime?
  accountsLastMadeUpTo          DateTime?
  accountsOverdue               Boolean?
  accountsAccountingReferenceDay Int?
  accountsAccountingReferenceMonth Int?
  
  // Confirmation statement (from CH API)
  confirmationStatementNextDue     DateTime?
  confirmationStatementLastMadeUpTo DateTime?
  confirmationStatementOverdue     Boolean?
  
  source          String?    // 'companies_house', 'manual', etc.
  lastSyncedAt    DateTime?  // When last synced with CH API
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  portfolio Portfolio @relation(fields: [portfolioCode], references: [code])
  parties   ClientParty[]
  services  Service[]
  tasks     Task[]
  filings   Filing[]
  documents Document[]
  events    Event[]
  taxCalculations TaxCalculation[]
  generatedReports GeneratedReport[]
  companiesHouseData CompaniesHouseData?

  @@index([portfolioCode])
  @@index([name])
  @@index([ref])
  @@index([companyNumber])
  @@index([companyStatus])
  @@map("clients")
}

model Person {
  id        String  @id @default(cuid())
  ref       String  @unique
  firstName String
  lastName  String
  email     String? @db.VarChar(320)
  phone     String?
  
  // Companies House officer specific fields
  nationality           String?
  countryOfResidence    String?
  occupation            String?
  dateOfBirthMonth      Int?
  dateOfBirthYear       Int?
  
  // Officer address (from CH API)
  addressLine1          String?
  addressLine2          String?
  locality              String?
  region                String?
  postalCode            String?
  country               String?
  premises              String?
  
  // CH API metadata
  personNumber          String?  // person_number from CH API
  etag                  String?  // etag from CH API
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  parties ClientParty[]

  @@index([firstName, lastName])
  @@index([email])
  @@index([personNumber])
  @@map("people")
}

enum PartyRole {
  DIRECTOR
  SHAREHOLDER
  PARTNER
  MEMBER
  OWNER
  UBO
  SECRETARY
  CONTACT
}

model ClientParty {
  id               String    @id @default(cuid())
  clientId         String
  clientRef        String?
  personId         String
  personRef        String?
  role             PartyRole
  ownershipPercent Decimal?  @db.Decimal(5, 2)
  appointedAt      DateTime?
  resignedAt       DateTime?
  primaryContact   Boolean   @default(false)
  suffixLetter     String    // A, B, C...
  
  // Companies House specific fields
  officerRole      String?   // officer_role from CH API (director, secretary, etc.)
  appointedOn      DateTime? // appointed_on from CH API
  resignedOn       DateTime? // resigned_on from CH API
  isPre1992Appointment Boolean @default(false) // is_pre_1992_appointment from CH API
  
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  person Person @relation(fields: [personId], references: [id])

  @@unique([clientId, suffixLetter])
  @@index([clientId])
  @@index([clientRef])
  @@index([personId])
  @@index([personRef])
  @@index([officerRole])
  @@map("client_parties")
}

enum Frequency {
  ANNUAL
  QUARTERLY
  MONTHLY
  WEEKLY
}

model Service {
  id          String    @id @default(cuid())
  clientId    String
  clientRef   String?
  kind        String    // e.g. Accounts, Payroll, VAT
  frequency   Frequency
  fee         Decimal   @db.Decimal(10, 2)
  status      String    @default("ACTIVE")
  nextDue     DateTime?
  annualized  Decimal   @db.Decimal(12, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks  Task[]

  @@index([clientId])
  @@index([clientRef])
  @@index([status])
  @@map("services")
}

model Task {
  id          String    @id @default(cuid())
  clientId    String
  clientRef   String?
  serviceId   String?
  title       String
  description String?
  dueDate     DateTime?
  assignee    String?
  status      String    @default("OPEN")
  priority    String    @default("MEDIUM") // HIGH, MEDIUM, LOW
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  client  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])

  @@index([clientId])
  @@index([clientRef])
  @@index([status])
  @@index([dueDate])
  @@index([assignee])
  @@map("tasks")
}

model Filing {
  id        String    @id @default(cuid())
  clientId  String
  clientRef String?
  type      String    // ANNUAL_ACCOUNTS, CONFIRMATION_STATEMENT, etc.
  period    String?
  dueDate   DateTime?
  status    String    // PENDING, FILED, OVERDUE, EXEMPT
  source    String    // 'companies_house', 'manual', etc.
  
  // Companies House specific fields
  transactionId     String?   // transaction_id from CH filing history
  category          String?   // category from CH API (accounts, confirmation-statement, etc.)
  description       String?   // description from CH API
  actionDate        DateTime? // action_date from CH API
  filedDate         DateTime? // date from CH API
  barcode           String?   // barcode from CH API
  pages             Int?      // pages from CH API
  paperFiled        Boolean?  // paper_filed from CH API
  
  reference         String?   // Company number or other reference
  madeUpTo          DateTime? // made_up_to date for accounts
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([clientRef])
  @@index([dueDate])
  @@index([status])
  @@index([type])
  @@index([transactionId])
  @@map("filings")
}

model Document {
  id        String   @id @default(cuid())
  clientId  String
  clientRef String?
  title     String
  kind      String
  path      String
  size      Int?
  mimeType  String?
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([clientRef])
  @@index([kind])
  @@map("documents")
}

model Event {
  id       String   @id @default(cuid())
  ts       DateTime @default(now())
  actor    String
  entity   String
  entityId String
  entityRef String?
  action   String
  payload  Json

  client Client? @relation(fields: [entityId], references: [id])

  @@index([entity, entityId])
  @@index([entityRef])
  @@index([ts])
  @@map("events")
}

model RefBucket {
  id          String @id @default(cuid())
  portfolio   Int
  alpha       String
  nextIndex   Int    @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([portfolio, alpha])
  @@map("ref_buckets")
}

// Store raw Companies House API responses for audit and sync purposes
model CompaniesHouseData {
  id            String   @id @default(cuid())
  clientId      String   @unique
  clientRef     String?  @unique
  companyNumber String   @unique
  
  // Raw API responses stored as JSON
  companyDetails    Json?    // Full company details response
  officers          Json?    // Officers list response
  filingHistory     Json?    // Filing history response
  charges           Json?    // Charges response
  pscs              Json?    // Persons with significant control
  
  lastFetched       DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  client Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([companyNumber])
  @@index([clientRef])
  @@index([lastFetched])
  @@map("companies_house_data")
}

model CalendarEvent {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  clientId    String?
  clientRef   String?
  taskId      String?
  type        String    @default("APPOINTMENT") // APPOINTMENT, DEADLINE, MEETING
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([startDate])
  @@index([clientId])
  @@index([clientRef])
  @@map("calendar_events")
}

// ==============================
// Postgres authority (replacing practice-manager.db)
// ==============================

enum TaxCalculationType {
  SALARY_OPTIMIZATION
  SCENARIO_COMPARISON
  CORPORATION_TAX
  DIVIDEND_TAX
  INCOME_TAX
  SOLE_TRADER
}

model TaxCalculation {
  id               String             @id
  clientId         String?
  clientRef        String?
  companyId        String?
  calculationType  TaxCalculationType
  taxYear          String
  parameters       Json?
  optimizedSalary  Decimal?           @db.Decimal(12, 2)
  optimizedDividend Decimal?          @db.Decimal(12, 2)
  totalTakeHome    Decimal?           @db.Decimal(12, 2)
  totalTaxLiability Decimal?          @db.Decimal(12, 2)
  estimatedSavings Decimal?           @db.Decimal(12, 2)
  recommendations  Json?
  calculatedAt     DateTime?          @default(now())
  calculatedBy     String?
  notes            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  client  Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  scenarios TaxScenario[]
  reports  GeneratedReport[]

  @@index([clientId])
  @@index([clientRef])
  @@index([calculatedAt])
  @@index([calculationType])
  @@index([taxYear])
  @@map("tax_calculations")
}

model TaxScenario {
  id            String  @id
  calculationId String
  scenarioName  String?
  salary        Decimal? @db.Decimal(12, 2)
  dividend      Decimal? @db.Decimal(12, 2)
  incomeTax     Decimal? @db.Decimal(12, 2)
  employeeNi    Decimal? @db.Decimal(12, 2)
  employerNi    Decimal? @db.Decimal(12, 2)
  dividendTax   Decimal? @db.Decimal(12, 2)
  corporationTax Decimal? @db.Decimal(12, 2)
  totalTax      Decimal? @db.Decimal(12, 2)
  takeHome      Decimal? @db.Decimal(12, 2)
  effectiveRate Decimal? @db.Decimal(8, 4)

  calculation TaxCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  @@index([calculationId])
  @@map("tax_scenarios")
}

enum ReportFormat {
  PDF
  HTML
}

model GeneratedReport {
  id             String       @id
  clientId       String?
  clientRef      String?
  calculationId  String?
  templateId     String?
  title          String
  content        Json?
  format         ReportFormat
  filePath       String?
  generatedAt    DateTime?    @default(now())
  generatedBy    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  client       Client?        @relation(fields: [clientId], references: [id], onDelete: SetNull)
  calculation  TaxCalculation? @relation(fields: [calculationId], references: [id], onDelete: SetNull)

  @@index([clientId])
  @@index([clientRef])
  @@index([generatedAt])
  @@map("generated_reports")
}