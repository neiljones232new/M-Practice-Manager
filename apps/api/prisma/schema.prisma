generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Portfolio {
  code        Int      @id
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  clients     Client[]

  @@map("portfolios")
}

model RefBucket {
  id        String   @id @default(cuid())
  portfolio Int
  alpha     String
  nextIndex Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([portfolio, alpha])
  @@map("ref_buckets")
}

model Client {
  id                                String              @id
  ref                               String              @unique
  name                              String
  type                              ClientType
  portfolioCode                     Int
  status                            String              @default("ACTIVE")
  mainEmail                         String?             @db.VarChar(320)
  mainPhone                         String?
  source                            String?
  createdAt                         DateTime            @default(now())
  updatedAt                         DateTime            @updatedAt
  accountsAccountingReferenceDay    Int?
  accountsAccountingReferenceMonth  Int?
  accountsLastMadeUpTo              DateTime?
  accountsNextDue                   DateTime?
  accountsOverdue                   Boolean?
  companyName                       String?
  companyNumber                     String?             @unique
  companyStatus                     String?
  companyType                       String?
  confirmationStatementLastMadeUpTo DateTime?
  confirmationStatementNextDue      DateTime?
  confirmationStatementOverdue      Boolean?
  dateOfCessation                   DateTime?
  dateOfCreation                    DateTime?
  etag                              String?
  jurisdiction                      String?
  lastSyncedAt                      DateTime?
  registeredOfficeAddressLine1      String?
  registeredOfficeAddressLine2      String?
  registeredOfficeCountry           String?
  registeredOfficeLocality          String?
  registeredOfficePostalCode        String?
  registeredOfficeRegion            String?
  sicCodes                          String[]
  accountLastFour                   String?
  accountingPeriodEnd               String?
  accountsOfficeReference           String?
  amlCompleted                      Boolean?
  annualFee                         Decimal?            @db.Decimal(12, 2)
  authenticationCode                String?
  businessBankName                  String?
  ceasedAt                          DateTime?
  cisRegistered                     Boolean?
  cisUtr                            String?
  clientManager                     String?
  clientRiskRating                  String?
  clientType                        String?
  contactPosition                   String?
  corporationTaxUtr                 String?
  correspondenceAddress             String?
  dateOfBirth                       DateTime?
  directDebitInPlace                Boolean?
  directorRole                      String?
  disengagementDate                 DateTime?
  doNotContact                      Boolean?
  dormant                           Boolean?
  dormantSince                      DateTime?
  email                             String?             @db.VarChar(320)
  employeeCount                     Int?
  engagementLetterSigned            Boolean?
  engagementType                    String?
  feeArrangement                    String?
  lifecycleStatus                   String?
  linkedCompanyNumber               String?
  mainContactName                   String?
  mobile                            String?
  monthlyFee                        Decimal?            @db.Decimal(12, 2)
  nationalInsuranceNumber           String?
  nextAccountsDueDate               DateTime?
  nextCorporationTaxDueDate         DateTime?
  notes                             String?
  onboardingDate                    DateTime?
  onboardingStartedAt               DateTime?
  partnerResponsible                String?
  payeAccountsOfficeReference       String?
  payeReference                     String?
  paymentIssues                     String?
  payrollFrequency                  String?
  payrollPayDay                     Int?
  payrollPeriodEndDay               Int?
  payrollRtiRequired                Boolean?
  personalAddress                   String?
  personalTaxYear                   String?
  personalUtr                       String?
  preferredContactMethod            String?
  registeredAddress                 String?
  seasonalBusiness                  Boolean?
  selfAssessmentFiled               Boolean?
  selfAssessmentRequired            Boolean?
  selfAssessmentTaxYear             String?
  specialCircumstances              String?
  statutoryYearEnd                  String?
  telephone                         String?
  tradingName                       String?
  utrNumber                         String?
  vatNumber                         String?
  vatPeriodEnd                      String?
  vatPeriodStart                    String?
  vatQuarter                        String?
  vatRegistrationDate               DateTime?
  vatReturnFrequency                String?
  vatScheme                         String?
  vatStagger                        String?
  wentLiveAt                        DateTime?
  parties                           ClientParty[]
  portfolio                         Portfolio           @relation(fields: [portfolioCode], references: [code])
  companiesHouseData                CompaniesHouseData?
  documents                         Document[]
  auditEvents                       Event[]             @relation("ClientEvents")
  filings                           Filing[]
  generatedReports                  GeneratedReport[]
  services                          Service[]
  tasks                             Task[]
  taxCalculations                   TaxCalculation[]

  @@index([portfolioCode])
  @@index([name])
  @@index([companyNumber])
  @@index([companyStatus])
  @@index([ref])
  @@map("clients")
}

model Service {
  id         String    @id @default(cuid())
  clientId   String
  kind       String
  frequency  Frequency
  fee        Decimal   @db.Decimal(10, 2)
  status     String    @default("ACTIVE")
  nextDue    DateTime?
  annualized Decimal   @db.Decimal(12, 2)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  clientRef  String?
  client     Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tasks      Task[]

  @@index([clientId])
  @@index([clientRef])
  @@index([status])
  @@map("services")
}

model Task {
  id          String    @id @default(cuid())
  clientId    String
  serviceId   String?
  title       String
  description String?
  dueDate     DateTime?
  assignee    String?
  status      String    @default("OPEN")
  priority    String    @default("MEDIUM")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  clientRef   String?
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  service     Service?  @relation(fields: [serviceId], references: [id])

  @@index([assignee])
  @@index([clientId])
  @@index([clientRef])
  @@index([dueDate])
  @@index([status])
  @@map("tasks")
}

model Document {
  id        String   @id @default(cuid())
  clientId  String
  title     String
  kind      String
  path      String
  size      Int?
  mimeType  String?
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clientRef String?
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([clientRef])
  @@index([kind])
  @@map("documents")
}

model Person {
  id                 String        @id @default(cuid())
  ref                String        @unique
  firstName          String
  lastName           String
  email              String?       @db.VarChar(320)
  phone              String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  addressLine1       String?
  addressLine2       String?
  country            String?
  countryOfResidence String?
  dateOfBirthMonth   Int?
  dateOfBirthYear    Int?
  etag               String?
  locality           String?
  nationality        String?
  occupation         String?
  personNumber       String?
  postalCode         String?
  premises           String?
  region             String?
  clientParties      ClientParty[]

  @@index([email])
  @@index([firstName, lastName])
  @@index([personNumber])
  @@map("people")
}

model ClientParty {
  id                   String    @id @default(cuid())
  clientId             String
  personId             String
  role                 PartyRole
  ownershipPercent     Decimal?  @db.Decimal(5, 2)
  appointedAt          DateTime?
  resignedAt           DateTime?
  primaryContact       Boolean   @default(false)
  suffixLetter         String
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  appointedOn          DateTime?
  isPre1992Appointment Boolean   @default(false)
  officerRole          String?
  resignedOn           DateTime?
  clientRef            String?
  personRef            String?
  client               Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  person               Person    @relation(fields: [personId], references: [id])

  @@unique([clientId, suffixLetter])
  @@index([clientId])
  @@index([clientRef])
  @@index([officerRole])
  @@index([personId])
  @@index([personRef])
  @@map("client_parties")
}

model CompaniesHouseData {
  id             String   @id @default(cuid())
  clientId       String   @unique
  companyNumber  String   @unique
  companyDetails Json?
  officers       Json?
  filingHistory  Json?
  charges        Json?
  pscs           Json?
  lastFetched    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  clientRef      String?  @unique
  client         Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([companyNumber])
  @@index([lastFetched])
  @@index([clientRef])
  @@map("companies_house_data")
}

model Filing {
  id            String    @id @default(cuid())
  clientId      String
  type          String
  period        String?
  dueDate       DateTime?
  status        String
  source        String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  actionDate    DateTime?
  barcode       String?
  category      String?
  description   String?
  filedDate     DateTime?
  madeUpTo      DateTime?
  pages         Int?
  paperFiled    Boolean?
  reference     String?
  transactionId String?
  clientRef     String?
  client        Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([dueDate])
  @@index([status])
  @@index([type])
  @@index([transactionId])
  @@index([clientRef])
  @@map("filings")
}

model TaxCalculation {
  id                String             @id @default(cuid())
  clientId          String?
  clientRef         String?
  companyId         String?
  calculationType   TaxCalculationType
  taxYear           String
  parameters        Json?
  optimizedSalary   Decimal?           @db.Decimal(12, 2)
  optimizedDividend Decimal?           @db.Decimal(12, 2)
  totalTakeHome     Decimal?           @db.Decimal(12, 2)
  totalTaxLiability Decimal?           @db.Decimal(12, 2)
  estimatedSavings  Decimal?           @db.Decimal(12, 2)
  recommendations   Json?
  calculatedAt      DateTime?          @default(now())
  calculatedBy      String?
  notes             String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  reports           GeneratedReport[]
  client            Client?            @relation(fields: [clientId], references: [id])
  scenarios         TaxScenario[]

  @@index([clientId])
  @@index([calculatedAt])
  @@index([calculationType])
  @@index([taxYear])
  @@index([clientRef])
  @@map("tax_calculations")
}

model TaxScenario {
  id             String         @id @default(cuid())
  calculationId  String
  scenarioName   String?
  salary         Decimal?       @db.Decimal(12, 2)
  dividend       Decimal?       @db.Decimal(12, 2)
  incomeTax      Decimal?       @db.Decimal(12, 2)
  employeeNi     Decimal?       @db.Decimal(12, 2)
  employerNi     Decimal?       @db.Decimal(12, 2)
  dividendTax    Decimal?       @db.Decimal(12, 2)
  corporationTax Decimal?       @db.Decimal(12, 2)
  totalTax       Decimal?       @db.Decimal(12, 2)
  takeHome       Decimal?       @db.Decimal(12, 2)
  effectiveRate  Decimal?       @db.Decimal(8, 4)
  calculation    TaxCalculation @relation(fields: [calculationId], references: [id], onDelete: Cascade)

  @@index([calculationId])
  @@map("tax_scenarios")
}

model GeneratedReport {
  id            String          @id @default(cuid())
  clientId      String?
  clientRef     String?
  calculationId String?
  templateId    String?
  title         String
  content       Json?
  format        ReportFormat
  filePath      String?
  generatedAt   DateTime?       @default(now())
  generatedBy   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  calculation   TaxCalculation? @relation(fields: [calculationId], references: [id])
  client        Client?         @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([generatedAt])
  @@index([clientRef])
  @@map("generated_reports")
}

model CalendarEvent {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime?
  allDay      Boolean   @default(false)
  clientId    String?
  taskId      String?
  type        String    @default("APPOINTMENT")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  clientRef   String?

  @@index([startDate])
  @@index([clientId])
  @@index([clientRef])
  @@map("calendar_events")
}

model Event {
  id        String   @id @default(cuid())
  ts        DateTime @default(now())
  actor     String
  entity    String
  entityId  String
  action    String
  payload   Json
  entityRef String?
  client    Client   @relation("ClientEvents", fields: [entityId], references: [id])

  @@index([entity, entityId])
  @@index([entityRef])
  @@index([ts])
  @@map("events")
}

enum ClientType {
  COMPANY
  INDIVIDUAL
  SOLE_TRADER
  PARTNERSHIP
  LLP
}

enum TaxCalculationType {
  SALARY_OPTIMIZATION
  SCENARIO_COMPARISON
  CORPORATION_TAX
  DIVIDEND_TAX
  INCOME_TAX
  SOLE_TRADER
}

enum ReportFormat {
  PDF
  HTML
}

enum Frequency {
  ANNUAL
  QUARTERLY
  MONTHLY
  WEEKLY
}

enum PartyRole {
  DIRECTOR
  SHAREHOLDER
  PARTNER
  MEMBER
  OWNER
  UBO
  SECRETARY
  CONTACT
}
